<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PDF Viewer</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { width: 100%; height: 100%; overflow: hidden; background: #1a1a1a; }

  /* ── spread container ── */
  #viewer {
    width: 100%; height: 100%;
    overflow-y: auto; overflow-x: hidden;
    display: flex; flex-direction: column; align-items: center;
    padding: 12px 0;
    scrollbar-width: thin;
    scrollbar-color: #555 #222;
  }
  #viewer::-webkit-scrollbar { width: 8px; }
  #viewer::-webkit-scrollbar-track { background: #222; }
  #viewer::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }

  .spread-row {
    display: flex; justify-content: center; align-items: flex-start;
    gap: 4px; margin-bottom: 8px; flex-shrink: 0;
  }
  .spread-row canvas {
    display: block;
    box-shadow: 0 2px 12px rgba(0,0,0,.6);
    background: #fff;
  }

  /* ── loading overlay ── */
  #loading {
    position: fixed; inset: 0;
    display: flex; align-items: center; justify-content: center;
    background: #1a1a1a; color: #aaa;
    font-family: system-ui, sans-serif; font-size: 15px;
    z-index: 10; transition: opacity .3s;
  }
  #loading.hidden { opacity: 0; pointer-events: none; }
</style>
</head>
<body>

<div id="loading">Loading PDF…</div>
<div id="viewer"></div>

<!-- PDF.js from CDN (stable 4.x) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.min.mjs" type="module"></script>
<script type="module">
import * as pdfjsLib from 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.min.mjs';

pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.worker.min.mjs';

const params  = new URLSearchParams(window.location.search);
const pdfUrl  = params.get('file') || 'bible.pdf';
const viewer  = document.getElementById('viewer');
const loading = document.getElementById('loading');

(async () => {
  const pdf = await pdfjsLib.getDocument(pdfUrl).promise;
  const totalPages = pdf.numPages;

  /* ── Determine available width for scaling ── */
  function getScale(page) {
    const vp = page.getViewport({ scale: 1 });
    // Two pages side-by-side: each gets ~half the container width minus gaps
    const availWidth = (viewer.clientWidth / 2) - 20;
    const availHeight = viewer.clientHeight - 32;
    const scaleW = availWidth / vp.width;
    const scaleH = availHeight / vp.height;
    return Math.min(scaleW, scaleH, 2.5);          // cap at 2.5×
  }

  /* ── Render one page onto a canvas ── */
  async function renderPage(pageNum) {
    const page = await pdf.getPage(pageNum);
    const scale = getScale(page);
    const vp = page.getViewport({ scale });
    const canvas = document.createElement('canvas');
    canvas.width  = vp.width;
    canvas.height = vp.height;
    const ctx = canvas.getContext('2d');
    await page.render({ canvasContext: ctx, viewport: vp }).promise;
    return canvas;
  }

  /* ── Build spread rows: page 1 alone, then 2-3, 4-5, … ── */
  const spreads = [[1]];                            // cover page solo
  for (let p = 2; p <= totalPages; p += 2) {
    if (p + 1 <= totalPages) spreads.push([p, p + 1]);
    else spreads.push([p]);
  }

  for (const pages of spreads) {
    const row = document.createElement('div');
    row.className = 'spread-row';
    for (const pNum of pages) {
      const canvas = await renderPage(pNum);
      row.appendChild(canvas);
    }
    viewer.appendChild(row);
  }

  loading.classList.add('hidden');

  /* ── Re-render on resize ── */
  let resizeTimer;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(async () => {
      const scrollRatio = viewer.scrollTop / (viewer.scrollHeight || 1);
      viewer.innerHTML = '';
      for (const pages of spreads) {
        const row = document.createElement('div');
        row.className = 'spread-row';
        for (const pNum of pages) {
          const canvas = await renderPage(pNum);
          row.appendChild(canvas);
        }
        viewer.appendChild(row);
      }
      viewer.scrollTop = scrollRatio * viewer.scrollHeight;
    }, 250);
  });
})();
</script>
</body>
</html>
